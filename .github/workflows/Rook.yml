name: RJM Rook ðŸŒ

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build rook.m3u (Sliv + Z5 + Viacom18 + Jcinema â†’ Sorted â†’ Wand folder)
        run: |
          set -e
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          mkdir -p Wand

          SONY_URL="https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u"
          Z5_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u"
          JCINEMA_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jcinema.m3u"

          echo "ðŸ”¹ Build started at $timestamp"

          # -------------------------------------------------------------
          # SLIV (SONY) â€” ORIGINAL LOGIC (unchanged) + EXTINF FIX
          # -------------------------------------------------------------
          echo "ðŸŒ Fetching SONY playlist..."
          curl -fsSL "$SONY_URL" \
            | grep -v -E '^#EXTM3U|# Join|# Pushed' \
            > "$tmpdir/sony_raw.m3u"

          echo "ðŸ›  Applying Sliv EXTINF format fix..."
          sed -E \
            's/group-title="[^"]*"/group-title="Sliv"/g;
             s/#EXTINF:[^,]*/#EXTINF:-1 group-title="Sliv"/g' \
            "$tmpdir/sony_raw.m3u" > "$tmpdir/sliv_clean.m3u"

          SLIV_COUNT=$(grep -c 'group-title="Sliv"' "$tmpdir/sliv_clean.m3u")


          # -------------------------------------------------------------
          # Z5 â€” SAFE URL DETECTION
          # -------------------------------------------------------------
          echo "ðŸŒ Fetching Z5 playlist..."
          curl -fsSL "$Z5_URL" \
            | grep -v -E '^#EXTM3U|# Join|# Pushed' \
            > "$tmpdir/z5_raw.m3u"

          echo "ðŸ›  Processing Z5 channels (URL fix)..."
          awk '
            /^#EXTINF/ {
                match($0, /,(.*)$/, m)
                name=m[1]
                print "#EXTINF:-1 group-title=\"Z5\"," name
                while (getline url) {
                    if (url ~ /^https?:\/\//) { print url; break }
                }
            }
          ' "$tmpdir/z5_raw.m3u" > "$tmpdir/z5_clean.m3u"

          Z5_COUNT=$(grep -c 'group-title="Z5"' "$tmpdir/z5_clean.m3u")


          # -------------------------------------------------------------
          # JCINEMA â€” SMART GROUPING (Viacom18 or Jcinema)
          # -------------------------------------------------------------
          echo "ðŸŒ Fetching Jcinema playlist..."
          curl -fsSL "$JCINEMA_URL" \
            | grep -v -E '^#EXTM3U|# Join|# Pushed' \
            > "$tmpdir/jcinema_raw.m3u"

          echo "ðŸ›  Processing Jcinema channels â†’ Viacom18 OR Jcinema..."
          awk '
            /^#EXTINF/ {
                match($0, /,(.*)$/, m)
                name=m[1]
                lname=tolower(name)

                if (lname ~ /colors/ || lname ~ /viacom/) {
                    print "#EXTINF:-1 group-title=\"Viacom18\"," name
                } else {
                    print "#EXTINF:-1 group-title=\"Jcinema\"," name
                }

                while (getline url) {
                    if (url ~ /^https?:\/\//) { print url; break }
                }
            }
          ' "$tmpdir/jcinema_raw.m3u" > "$tmpdir/jcinema_clean.m3u"

          VIACOM18_COUNT=$(grep -c 'group-title="Viacom18"' "$tmpdir/jcinema_clean.m3u")
          JCINEMA_COUNT=$(grep -c 'group-title="Jcinema"' "$tmpdir/jcinema_clean.m3u")


          # -------------------------------------------------------------
          # MERGE + SORT EVERYTHING
          # -------------------------------------------------------------
          echo "ðŸ”„ Sorting channels alphabetically..."

          cat "$tmpdir/sliv_clean.m3u" \
              "$tmpdir/z5_clean.m3u" \
              "$tmpdir/jcinema_clean.m3u" \
              > "$tmpdir/merged_unsorted.m3u"

          awk '
            /^#EXTINF/ { ext=$0; getline url; print ext "|" url }
          ' "$tmpdir/merged_unsorted.m3u" \
            | sort -t',' -k2 \
            | awk -F"|" '{ print $1 ORS $2 }' \
            > "$tmpdir/final_sorted.m3u"

          TOTAL=$(grep -c '^#EXTINF' "$tmpdir/final_sorted.m3u")
          UPDATED="$TOTAL"


          # -------------------------------------------------------------
          # WRITE FINAL FILE
          # -------------------------------------------------------------
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo "# Channels : Total - $TOTAL | Updated - $UPDATED"
            echo "# Sliv - $SLIV_COUNT | Z5 - $Z5_COUNT | Viacom18 - $VIACOM18_COUNT | Jcinema - $JCINEMA_COUNT"
            echo ""
          } > Wand/rook.m3u

          cat "$tmpdir/final_sorted.m3u" >> Wand/rook.m3u


      - name: Commit and push updated rook.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Wand/rook.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update rook.m3u (Sliv + Z5 + Viacom18 + Jcinema merged) | Total:${TOTAL}"
            git pull --rebase origin main || true
            git push origin main || true
          else
            echo "No changes detected."
          fi

      - name: Summary
        run: echo "âœ… Rook playlist updated successfully â€” Sliv + Z5 + Viacom18 + Jcinema merged at $(date)"
