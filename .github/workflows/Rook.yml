name: RJM Rook üåê

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build rook.m3u (Sony ‚Üí Sliv + Z5 ‚Üí Z5 Group ‚Üí Sorted ‚Üí Wand folder)
        run: |
          set -e
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          mkdir -p Wand

          SONY_URL="https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u"
          Z5_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u"

          echo "üîπ Build started at $timestamp"

          # ------------------------------
          # Fetch Sony Playlist
          # ------------------------------
          echo "üé¨ Fetching SONY playlist..."
          if curl -fsSL "$SONY_URL" | grep -v -E '^#EXTM3U|# Join|# Updated' \
              > "$tmpdir/sony_raw.m3u"; then
            echo "‚úÖ SONY playlist fetched."
          else
            echo "‚ùå Failed to fetch SONY playlist!"
            exit 1
          fi

          # Convert Sony entries ‚Üí Sliv group
          awk -F',' '
            /^#EXTINF/ {
                name=$2;
                print "#EXTINF:-1 group-title=\"Sliv\"," name;
                getline url;
                print url;
                next;
            }
          ' "$tmpdir/sony_raw.m3u" > "$tmpdir/sony_clean.m3u"

          # ------------------------------
          # Fetch Z5 Playlist
          # ------------------------------
          echo "üé¨ Fetching Z5 playlist..."
          if curl -fsSL "$Z5_URL" | grep -v -E '^#EXTM3U|# Join|# Updated' \
              > "$tmpdir/z5_raw.m3u"; then
            echo "‚úÖ Z5 playlist fetched."
          else
            echo "‚ùå Failed to fetch Z5 playlist!"
            exit 1
          fi

          # Convert Z5 entries ‚Üí Z5 group
          awk -F',' '
            /^#EXTINF/ {
                name=$2;
                print "#EXTINF:-1 group-title=\"Z5\"," name;
                getline url;
                print url;
                next;
            }
          ' "$tmpdir/z5_raw.m3u" > "$tmpdir/z5_clean.m3u"

          # ------------------------------
          # Merge Both Cleaned Playlists
          # ------------------------------
          cat "$tmpdir/sony_clean.m3u" "$tmpdir/z5_clean.m3u" \
            > "$tmpdir/merged_unsorted.m3u"

          echo "üîÑ Sorting merged playlist alphabetically..."

          # Sort based on channel name
          awk '
            /^#EXTINF/ { ext=$0; getline url; print ext "|" url }
          ' "$tmpdir/merged_unsorted.m3u" \
            | sort -t',' -k2 \
            | awk -F"|" '{ print $1 ORS $2 }' \
            > "$tmpdir/final_sorted.m3u"

          UPDATED=$(grep -c '^#EXTINF' "$tmpdir/final_sorted.m3u" || true)
          TOTAL="$UPDATED"

          # ------------------------------
          # Build Final Output File
          # ------------------------------
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo "# Channels : Total - $TOTAL | Sorted A-Z"
            echo ""
          } > Wand/rook.m3u

          cat "$tmpdir/final_sorted.m3u" >> Wand/rook.m3u

          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "UPDATED=$UPDATED" >> $GITHUB_ENV

          echo "üìä Total merged channels: $TOTAL"
          echo "‚úÖ rook.m3u created at Wand/rook.m3u"

      - name: Commit and push updated rook.m3m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Wand/rook.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update Wand/rook.m3u (Sony + Z5 | Sorted | Merged) | Total:${TOTAL}"
            git pull --rebase origin main || true

            for attempt in 1 2 3; do
              git push origin main && break
              echo "‚ö†Ô∏è Push failed, retrying‚Ä¶ ($attempt/3)"
              sleep 10
            done
          else
            echo "No changes detected."
          fi

      - name: Summary
        run: echo "‚úÖ Sony + Z5 merged Sliv/Z5 workflow completed at $(date)"
