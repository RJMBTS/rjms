name: King ðŸ‘‘

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: king-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge, Clean & Lock 24x7 â†’ King.m3u
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          {
            echo '#EXTM3U billed-msg="RJMS OTT - RJMBTS Network"'
            echo "# Pushed & Updated by Kittujk"
            echo "# Scripted & Maintained by @RJMBTS"
            echo "# Last updated: $timestamp"
          } > King.m3u

          SOURCES=(
            "https://raw.githubusercontent.com/RJMBTS/Rjms/refs/heads/main/master.m3u"
            "https://raw.githubusercontent.com/RJMBTS/Xfpl/refs/heads/main/Queen.m3u"
          )

          for url in "${SOURCES[@]}"; do
            curl -fs "$url" | grep -v '^#EXTM3U' >> "$tmpdir/all.m3u"
          done

          # ðŸ”¥ CLEAN PLAYLIST (CORRECT)
          awk '
          BEGIN { skip=0 }

          # âœ… Rename Movies â†’ RJM | 24x7
          /group-title="Movies"/ {
            gsub(/group-title="Movies"/, "group-title=\"RJM | 24x7\"")
          }

          # âŒ REMOVE ONLY "Telugu Movies" (Local | Telugu Movies card)
          /#EXTINF/ && /Telugu Movies/ && /group-title="RJM \| 24x7"/ {
            skip=1; next
          }

          # âŒ Remove Star & Gemini Movies
          /Star Maa Movies HD|Star Maa Movie|Gemini Movies HD|Gemini Movie/ {
            skip=1; next
          }

          # âŒ Remove TV Series
          /group-title="TV Series"/ {
            skip=1; next
          }

          skip==1 && /^[^#]/ { skip=0; next }
          skip==0 { print }
          ' "$tmpdir/all.m3u" > "$tmpdir/clean.m3u"

          # ðŸ”’ LOCK RJM | 24x7 AT TOP
          awk '
          BEGIN { top=""; rest="" }

          /group-title="RJM \| 24x7"/ {
            top = top $0 ORS
            getline; top = top $0 ORS
            next
          }

          { rest = rest $0 ORS }

          END {
            printf "%s", top
            printf "%s", rest
          }
          ' "$tmpdir/clean.m3u" >> King.m3u

          rm -rf "$tmpdir"

          echo "âœ… Telugu Movies (Local | Telugu) REMOVED"
          echo "ðŸ”’ RJM | 24x7 LOCKED AT TOP"

      - name: Commit and push King.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add King.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Fix: remove Telugu Movies from Local Telugu"
            git pull --rebase origin main || true
            git push origin main
          else
            echo "No changes detected"
          fi
