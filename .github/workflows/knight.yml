name: knight

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build knight.m3u (Grouped + Network Merge + NO Dedupe + Counts)
        run: |
          set -e
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "üîπ Build started at $timestamp"

          if [ ! -f base.txt ]; then
            echo "‚ùå base.txt not found!"
            exit 1
          fi

          grep -v '^$' base.txt > "$tmpdir/sources.txt"

          # Temp raw file (no header yet)
          : > "$tmpdir/raw.m3u"

          echo "üåê Fetching and grouping sources..."

          i=0
          while read -r url; do
            [[ -z "$url" ]] && continue
            i=$((i+1))

            fname=$(basename "${url%%\?*}")
            rawgroup=$(echo "${fname%.m3u}" | tr '[:lower:]' '[:upper:]')

            # ‚úÖ NETWORK AUTO-MERGE RULES
            if echo "$rawgroup" | grep -qi 'STAR'; then
              group="STAR"
            elif echo "$rawgroup" | grep -qi 'SONY'; then
              group="SONY"
            elif echo "$rawgroup" | grep -qi 'ZEE'; then
              group="ZEE"
            elif echo "$rawgroup" | grep -Eqi 'SUN|GEMINI|SURYA|UDAYA'; then
              group="SUN"
            elif echo "$rawgroup" | grep -qi 'ETV'; then
              group="ETV"
            elif echo "$rawgroup" | grep -Eqi 'VIACOM|COLORS'; then
              group="VIACOM/COLORS"
            else
              group="$rawgroup"
            fi

            echo "" >> "$tmpdir/raw.m3u"
            echo "################### $group ###################" >> "$tmpdir/raw.m3u"

            if curl -fs "$url" | \
              grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram' \
              > "$tmpdir/part_$i.m3u"; then

              cat "$tmpdir/part_$i.m3u" >> "$tmpdir/raw.m3u"
              echo "‚úÖ Grouped: $group"
            else
              echo "# ‚ö†Ô∏è Failed: $url" >> "$tmpdir/raw.m3u"
              echo "‚ö†Ô∏è Failed: $group"
            fi
          done < "$tmpdir/sources.txt"

          # ‚úÖ Count channels (NO dedupe ‚Üí Total = Updated)
          UPDATED=$(grep -c '^#EXTINF' "$tmpdir/raw.m3u" || true)
          TOTAL="$UPDATED"

          # ‚úÖ Write FINAL HEADER with COUNTS
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo "# Include Channels : Total - $TOTAL | Updated - $UPDATED"
            echo ""
          } > knight.m3u

          # ‚úÖ Append playlist (no deduplication)
          cat "$tmpdir/raw.m3u" >> knight.m3u

          echo "‚úÖ knight.m3u created successfully."
          echo "üìä Total: $TOTAL | Updated: $UPDATED"

      - name: Commit and push updated knight.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add knight.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update knight.m3u | Total:$TOTAL Updated:$UPDATED"
            git pull --rebase origin main || true

            n=0
            until [ "$n" -ge 3 ]
            do
              git push origin main && break
              n=$((n+1))
              echo "‚ö†Ô∏è Push failed, retrying in 10s... ($n/3)"
              sleep 10
            done
          else
            echo "No changes detected ‚Äî skipping commit."
          fi

      - name: Summary
        run: echo "‚úÖ Monster completed at $(date)"
