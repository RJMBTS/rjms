name: knight

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Master knight.m3u (Network Split + Auto Sort + YGX Removed)
        run: |
          set -e
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "üîπ Build started at $timestamp"

          if [ ! -f base.txt ]; then
            echo "‚ùå base.txt not found!"
            exit 1
          fi

          grep -v '^$' base.txt > "$tmpdir/sources.txt"
          mkdir -p "$tmpdir/groups"

          echo "üåê Fetching, filtering, grouping & sorting..."

          while read -r url; do
            [[ -z "$url" ]] && continue

            fname=$(basename "${url%%\?*}")
            rawgroup=$(echo "${fname%.m3u}" | tr '[:lower:]' '[:upper:]')

            # ‚úÖ NETWORK AUTO-MERGE RULES
            if echo "$rawgroup" | grep -qi 'STAR'; then
              group="STAR"
            elif echo "$rawgroup" | grep -qi 'SONY'; then
              group="SONY"
            elif echo "$rawgroup" | grep -qi 'ZEE'; then
              group="ZEE"
            elif echo "$rawgroup" | grep -Eqi 'SUN|GEMINI|SURYA|UDAYA'; then
              group="SUN"
            elif echo "$rawgroup" | grep -qi 'ETV'; then
              group="ETV"
            elif echo "$rawgroup" | grep -Eqi 'VIACOM|COLORS'; then
              group="VIACOM"
            else
              group="$rawgroup"
            fi

            outfile="$tmpdir/groups/$group.m3u"

            # ‚úÖ HARD BLOCK YGX WORLD (removes both EXTINF + URL)
            curl -fs --connect-timeout 10 --max-time 20 "$url" | \
              grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram' | \
              awk '
                BEGIN{IGNORECASE=1}
                /#EXTINF/ {
                  if ($0 ~ /YGX[[:space:]]*WORLD/) {
                    getline
                    next
                  }
                  print $0
                  getline
                  print $0
                }
              ' >> "$outfile" || true

            echo "‚úÖ Collected: $group"

          done < "$tmpdir/sources.txt"

          # ‚úÖ MASTER HEADER
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo ""
          } > knight.m3u

          TOTAL=0
          UPDATED=0

          # ‚úÖ APPEND ALL NETWORKS (SORTED A‚ÄìZ) INTO ONE FILE
          for file in "$tmpdir/groups/"*.m3u; do
            [ ! -s "$file" ] && continue

            groupname=$(basename "$file" .m3u)

            echo "" >> knight.m3u
            echo "################### $groupname ###################" >> knight.m3u

            awk '
              /^#EXTINF/ { meta=$0; getline url; print meta "\n" url }
            ' "$file" | sort -f >> knight.m3u

            count=$(grep -c '^#EXTINF' "$file" || true)
            UPDATED=$((UPDATED + count))
          done

          TOTAL="$UPDATED"

          sed -i "5i# Include Channels : Total - $TOTAL | Updated - $UPDATED" knight.m3u

          echo "‚úÖ knight.m3u created successfully."
          echo "üìä Total: $TOTAL | Updated: $UPDATED"

          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "UPDATED=$UPDATED" >> $GITHUB_ENV

      - name: Commit and push knight.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add knight.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update knight.m3u | Total:$TOTAL Updated:$UPDATED"
            git pull --rebase origin main || true

            n=0
            until [ "$n" -ge 3 ]
            do
              git push origin main && break
              n=$((n+1))
              echo "‚ö†Ô∏è Push failed, retrying in 10s... ($n/3)"
              sleep 10
            done
          else
            echo "No changes detected ‚Äî skipping commit."
          fi

      - name: Summary
        run: echo "‚úÖ Single-file knight build completed at $(date)"
