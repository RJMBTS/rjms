name: P1z üåê

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build P1z.m3u (Z5 ‚Üí RJM | Z5)
        id: buildfile
        env:
          SRC_URL: ${{ secrets.Z5_URL }}
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          mkdir -p Bishop
          OUTPUT="Bishop/P1z.m3u"

          echo "üåê Fetching Z5 playlist from secret..."
          curl -fsSL "$SRC_URL" -o "$tmpdir/z5_raw.m3u"

          # Remove unwanted header lines
          grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram' \
            "$tmpdir/z5_raw.m3u" > "$tmpdir/clean.m3u"

          # 1Ô∏è‚É£ Remove ANY existing group-title
          sed -E 's/group-title="[^"]*"//g' "$tmpdir/clean.m3u" > "$tmpdir/no_group.m3u"

          # 2Ô∏è‚É£ Force ALL channels into: RJM | Z5
          sed -E 's~^#EXTINF[^,]*~& group-title="RJM | Z5"~' \
            "$tmpdir/no_group.m3u" > "$tmpdir/final.m3u"

          UPDATED=$(grep -c '^#EXTINF' "$tmpdir/final.m3u" || true)
          TOTAL="$UPDATED"

          {
            echo '#EXTM3U billed-msg="RJMS - An RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
            echo "# Channels : Total - $TOTAL | Updated - $UPDATED"
            echo ""
            echo "################### RJM | Z5 ###################"
          } > "$OUTPUT"

          cat "$tmpdir/final.m3u" >> "$OUTPUT"

          echo "TOTAL=$TOTAL" >> "$GITHUB_ENV"
          echo "UPDATED=$UPDATED" >> "$GITHUB_ENV"
          echo "file-ready=true" >> "$GITHUB_OUTPUT"

          echo "üìÅ Output generated at: $OUTPUT"
          echo "üìä Total Channels: $TOTAL"

      - name: Commit and push P1z.m3u
        if: steps.buildfile.outputs.file-ready == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Bishop/P1z.m3u
          git diff --cached --quiet && echo "No changes ‚Äî skipping commit." && exit 0

          git commit -m "P1z Update | Total:${TOTAL} Updated:${UPDATED}"
          git pull --rebase origin main || true

          for i in 1 2 3; do
            git push origin main && break
            echo "‚ö†Ô∏è Push failed, retrying in 10s... ($i/3)"
            sleep 10
          done

      - name: Summary
        run: echo "‚úÖ P1z.m3u build completed successfully"
