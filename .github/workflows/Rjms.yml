name: RJMS ‚öì

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: rjms-generator
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate master.m3u from Rook
        run: |
          set -e

          SRC_URL="https://rjmbts.github.io/Rjms/Rook.m3u"
          OUTPUT="master.m3u"
          TMP=$(mktemp)

          echo "‚¨áÔ∏è Fetching source playlist..."
          curl -fsSL "$SRC_URL" -o "$TMP"

          COUNT=$(grep -c '^#EXTINF' "$TMP" || true)
          TIMESTAMP=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")

          echo "üß± Writing RJMS header..."
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed & Updated by Kittujk"
            echo "# Scripted & Maintained by @RJMBTS"
            echo "# Last updated on : $TIMESTAMP"
            echo "# Channels : Total - $COUNT | Updated - $COUNT"
            echo "# Made with ‚ù§ in India"
            echo ""
          } > "$OUTPUT"

          echo "üßπ Appending channels only..."
          awk 'BEGIN{start=0} /^#EXTINF/{start=1} start{print}' "$TMP" >> "$OUTPUT"

          echo "üîÅ Updating ONLY non-RJM group titles..."

          sed -i \
            -e 's/group-title="Extra"/group-title="RJM | Others"/g' \
            -e 's/group-title="Bengali"/group-title="RJM | Others"/g' \
            -e 's/group-title="SunNxt"/group-title="RJM | SunNxt"/g' \
            -e 's/group-title="Star"/group-title="RJM | Star"/g' \
            -e 's/group-title="Sony Liv"/group-title="RJM | SLiv"/g' \
            -e 's/group-title="Tamil"/group-title="RJM | Entertainment"/g' \
            "$OUTPUT"

          echo "‚úÖ Done. Existing RJM groups untouched."

      - name: Commit & Push Playlist
        run: |
          git config user.name "playlist-bot"
          git config user.email "bot@github.com"

          git add master.m3u
          git diff --cached --quiet && echo "‚ÑπÔ∏è No changes to commit" && exit 0

          git commit -m "Auto update master.m3u (safe group merge)"
          git push
