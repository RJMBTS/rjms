name: RJMS ‚öì

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: rjms-generator
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate master.m3u from Rook
        run: |
          set -e

          SRC_URL="https://rjmbts.github.io/Rjms/Rook.m3u"
          OUTPUT="master.m3u"
          TMP=$(mktemp)

          echo "‚¨áÔ∏è Fetching source playlist..."
          curl -fsSL "$SRC_URL" -o "$TMP"

          COUNT=$(grep -c '^#EXTINF' "$TMP" || true)
          TIMESTAMP=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")

          TOTAL_CHANNELS="$COUNT"
          UPDATED_CHANNELS="$COUNT"

          echo "üß± Writing RJMS header..."
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed & Updated by Kittujk"
            echo "# Scripted & Maintained by @RJMBTS"
            echo "# Last updated on : $TIMESTAMP"
            echo "# Channels : Total - $TOTAL_CHANNELS | Updated - $UPDATED_CHANNELS"
            echo "# Made with ‚ù§ on Telugu"
            echo ""
          } > "$OUTPUT"

          echo "üßπ Removing old headers & appending channels..."
          awk 'BEGIN{start=0} /^#EXTINF/{start=1} start{print}' "$TMP" >> "$OUTPUT"

          echo "‚úÖ master.m3u generated successfully"

      - name: Commit & Push Playlist
        run: |
          git config user.name "playlist-bot"
          git config user.email "bot@github.com"

          git add master.m3u
          git diff --cached --quiet && echo "‚ÑπÔ∏è No changes to commit" && exit 0

          git commit -m "Auto update master.m3u (RJMS)"
          git push
