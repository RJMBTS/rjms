name: P1jc ðŸŽ¬

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: master-m3u-jc
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build & Repair P1jc.m3u
        id: buildfile
        run: |
          set -e
          tmpdir=$(mktemp -d)

          mkdir -p Bishop
          OUTPUT="Bishop/P1jc.m3u"

          JC_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jcinema.m3u"

          echo "ðŸŽ¬ Fetching JCinema playlist..."
          curl -fs "$JC_URL" > "$tmpdir/raw.m3u"

          # Remove unwanted headers
          grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram|#Generated on' \
            "$tmpdir/raw.m3u" > "$tmpdir/step1.m3u"

          # Remove any old group-title safely
          sed -E 's/group-title="[^"]*"//g' "$tmpdir/step1.m3u" > "$tmpdir/step2.m3u"

          #########################################
          # ðŸ”§ MAIN FIX â†’ Repairs broken tvg-logo URL
          # Matches EXACT pattern in your file:
          #   resizeMedium group-title="RJM | JC",w_XXXX,h_XXXX/v3Storage/...
          #########################################
          sed -E \
            's#tvg-logo="([^"]*) group-title="[^"]*",w_([0-9]+,[0-9]+)/(v3Storage/[^"]*)#tvg-logo="\1_w_\2/\3#g' \
            "$tmpdir/step2.m3u" > "$tmpdir/step3.m3u"

          # Add correct group-title
          sed -E 's~^#EXTINF[^,]*~& group-title="RJM | JC"~' \
            "$tmpdir/step3.m3u" > "$tmpdir/final.m3u"

          UPDATED=$(grep -c '^#EXTINF' "$tmpdir/final.m3u" || true)
          TOTAL="$UPDATED"

          # Build final output
          {
            echo '#EXTM3U billed-msg="RJMS - An RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Channels : Total - $TOTAL | Updated - $UPDATED"
            echo ""
            echo "################### RJM | JC ###################"
          } > "$OUTPUT"

          cat "$tmpdir/final.m3u" >> "$OUTPUT"

          echo "file-ready=true" >> $GITHUB_OUTPUT
          echo "UPDATED=$UPDATED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: Commit and push P1jc.m3u
        if: steps.buildfile.outputs.file-ready == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Bishop/P1jc.m3u

          if ! git diff --cached --quiet; then
            git commit -m "P1jc Auto-Repair | Total:${TOTAL} Updated:${UPDATED}"
            git pull --rebase origin main || true
            git push origin main
          else
            echo "No changes â€” skipping commit."
          fi

      - name: Summary
        run: echo "âœ… P1jc.m3u build & repair completed successfully"
