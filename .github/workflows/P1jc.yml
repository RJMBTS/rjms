name: P1jc ðŸŒ

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: master-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build P1jc.m3u (OTT Navigator Compatible Grouping)
        id: buildfile
        run: |
          set -e
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          mkdir -p Bishop
          OUTPUT="Bishop/P1jc.m3u"
          JC_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jcinema.m3u"

          echo "ðŸŒ Fetching playlist..."
          curl -fsSL "$JC_URL" -o "$tmpdir/jc_raw.m3u"

          # Remove metadata lines
          grep -v -E '^#Generated on|# Join Telegram|#EXTM3U' \
            "$tmpdir/jc_raw.m3u" > "$tmpdir/clean.m3u"

          # Remove existing group-title
          sed -E 's/group-title="[^"]*"//g' "$tmpdir/clean.m3u" > "$tmpdir/tmp1.m3u"

          # Normalize whitespace
          sed -E 's/[[:space:]]+/ /g' "$tmpdir/tmp1.m3u" > "$tmpdir/tmp2.m3u"

          #############################################
          # 100% WORKING AWK GROUPING ENGINE
          #############################################

          awk '
          function trim(x){
              sub(/^[ \t\r\n]+/, "", x);
              sub(/[ \t\r\n]+$/, "", x);
              return x;
          }

          /^#EXTINF/ {
              line = $0

              # Break into attributes and channel name
              split(line, a, ",")
              attrs = a[1]
              name = trim(a[2])

              # Remove ANY form of #EXTINF prefix
              gsub(/^#EXTINF[^ ]* */, "", attrs)

              #############################
              # COLORS GROUP
              #############################
              if (name ~ /^Colors/ ||
                  name ~ /Cineplex/ ||
                  name ~ /^MTV/ ||
                  name ~ /^Nick/ ||
                  name ~ /Sonic/ ||
                  name ~ /^Vh1/ ||
                  name ~ /Comedy Central/) {

                  print "#EXTINF:-1 group-title=\"RJM | Colors Group\" " attrs "," name
                  next
              }

              #############################
              # VIACOM18 GROUP
              #############################
              if (name ~ /News18/ ||
                  name ~ /^CNBC/ ||
                  name ~ /TV18/) {

                  print "#EXTINF:-1 group-title=\"RJM | Viacom18\" " attrs "," name
                  next
              }

              # Default line
              print line
              next
          }

          { print }
          ' "$tmpdir/tmp2.m3u" > "$tmpdir/final.m3u"

          UPDATED=$(grep -c "^#EXTINF" "$tmpdir/final.m3u")
          TOTAL="$UPDATED"

          # Write final file
          {
            echo "#EXTM3U"
            echo "# Last updated: $timestamp"
            echo "# Channels: Total - $TOTAL"
          } > "$OUTPUT"

          cat "$tmpdir/final.m3u" >> "$OUTPUT"

          echo "file-ready=true" >> $GITHUB_OUTPUT

      - name: Commit and push updates
        if: steps.buildfile.outputs.file-ready == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Bishop/P1jc.m3u
          if ! git diff --cached --quiet; then
            git commit -m "P1jc M3U Auto Grouping Update (Viacom18 + Colors)"
            git pull --rebase origin main || true
            git push origin main || git push origin main
          else
            echo "No changes â€” skipping commit."
          fi

      - name: Summary
        run: echo "âœ… P1jc.m3u build completed successfully"
