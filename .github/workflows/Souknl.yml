name: Souknl ğŸ“¡

on:
  schedule:
    # Runs once every 24 hours (00:30 UTC = 06:00 IST)
    - cron: "30 0 * * *"

concurrency:
  group: souknl-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§© Build Souknl.m3u (Force Local | Kannada)
        shell: bash
        env:
          TZ: "Asia/Kolkata"
        run: |
          set -euxo pipefail

          mkdir -p Bishop
          out_file="Bishop/Souknl.m3u"

          SRC_URL="https://Rjmbts.github.io/Rjms/Souknl.m3u"
          timestamp=$(date +"%Y-%m-%d %H:%M:%S %Z")

          tmpfile=$(mktemp)
          trap 'rm -f "$tmpfile"' EXIT

          echo "ğŸŒ Fetching source:"
          echo "$SRC_URL"

          # ===== FETCH + FORCE GROUP =====
          curl -fsSL --max-time 60 "$SRC_URL" | awk '
            /^#EXTINF/ {
              info=$0
              if (info ~ /group-title="/) {
                sub(/group-title="[^"]*"/, "group-title=\"Local | Kannada\"", info)
              } else {
                sub(/^#EXTINF:-1 */, "#EXTINF:-1 group-title=\"Local | Kannada\" ", info)
              }
              print info
              next
            }
            { print }
          ' > "$tmpfile"

          # ===== COUNT CHANNELS =====
          total=$(grep -c "^#EXTINF" "$tmpfile" || echo 0)

          # ===== HEADER =====
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo '# Pushed and Updated by Kittujk'
            echo '# Coded & Maintained @RJMBTS'
            echo "# Last updated on : $timestamp"
            echo "# Channels : Total - $total | Updated - $total"
            echo
          } > "$out_file"

          # ===== MERGE =====
          cat "$tmpfile" >> "$out_file"

          echo "âœ… Bishop/Souknl.m3u generated successfully"
          echo "ğŸ“º Total channels: $total"

      - name: ğŸš€ Commit & Push Souknl.m3u
        shell: bash
        run: |
          set -euxo pipefail

          git config user.name "RJMBTS Auto Builder"
          git config user.email "actions@github.com"

          git add Bishop/Souknl.m3u || true

          if git diff --cached --quiet; then
            echo "No changes â€” skipping commit."
          else
            git commit -m "ğŸ”„ Auto-update Bishop/Souknl.m3u (Local | Kannada)"
            git pull --rebase origin main || git rebase --abort
            git push origin main || echo "âš ï¸ Push failed"
          fi
