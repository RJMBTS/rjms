name: P1js ðŸŒ

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: master-m3u-p1js
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build P1js.m3u
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          mkdir -p Bishop
          OUTPUT="Bishop/P1js.m3u"
          SRC_URL="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u"

          echo "â¬‡ï¸ Downloading source playlist..."
          curl -fsSL "$SRC_URL" -o "$tmpdir/raw.m3u"

          # âœ… Count channels (NO dedupe â†’ Total = Updated)
          UPDATED=$(grep -c '^#EXTINF' "$tmpdir/raw.m3u" || true)
          TOTAL="$UPDATED"

          # âœ… Write FINAL HEADER with COUNTS
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated on : $timestamp"
            echo "# Include Channels : Total - $TOTAL | Updated - $UPDATED"
            echo ""
          } > "$OUTPUT"

          # âœ… Append playlist (no deduplication)
          cat "$tmpdir/raw.m3u" >> "$OUTPUT"

          echo "âœ… P1js.m3u created successfully."
          echo "ðŸ“Š Total: $TOTAL | Updated: $UPDATED"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Bishop/P1js.m3u
          git commit -m "Auto update P1js.m3u" || echo "No changes to commit"
          git push
