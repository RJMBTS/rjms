name: P1js ğŸŒ

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: master-m3u-p1js
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build P1js.m3u
        env:
          SRC_URL: ${{ secrets.JSTAR_URL }}
        run: |
          set -e

          # ---------- SAFETY ----------
          [ -z "$SRC_URL" ] && { echo "âŒ SRC_URL missing"; exit 1; }

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          mkdir -p Bishop
          OUTPUT="Bishop/P1js.m3u"

          echo "â¬‡ï¸ Downloading source playlist..."
          curl --retry 3 --retry-delay 5 -fsSL "$SRC_URL" -o "$tmpdir/raw.m3u"

          TOTAL=$(grep -c '^#EXTINF' "$tmpdir/raw.m3u" || true)
          UPDATED="$TOTAL"

          echo "ğŸ§± Writing header..."
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated on : $timestamp"
            echo "# Channels : Total - $TOTAL | Updated - $UPDATED"
            echo ""
          } > "$OUTPUT"

          echo "ğŸ§© Processing & grouping channels..."
          awk '
          BEGIN { IGNORECASE=1 }

          /^#EXTINF/ {
            line=$0

            # â˜€ï¸ SUN NETWORK / SunNxt â†’ RJM | SunNxt
            if (line ~ /sun tv|sun network|sun music|sun movies|sun life|k tv|ktv|chutti tv|adithya|sirippoli|gemini|udaya|surya|sunnxt/) {
              gsub(/group-title="[^"]*"/, "group-title=\"RJM | SunNxt\"", line)
            }

            # â­ STAR CHANNELS â†’ RJM | Star
            else if (line ~ /\bstar\b|hotstar|maa|asianet/) {
              gsub(/group-title="[^"]*"/, "group-title=\"RJM | Star\"", line)
            }

            # ğŸ¬ TAMIL CHANNELS â†’ RJM | Entertainment
            else if (line ~ /tamil|vijay|zee tamil|colors tamil|raj tv|polimer/) {
              gsub(/group-title="[^"]*"/, "group-title=\"RJM | Entertainment\"", line)
            }

            # ğŸ“° EXTRA + BENGALI â†’ RJM | News
            else if (line ~ /extra|bengali|bangla|abp ananda|zee 24 ghanta|news18 bangla/) {
              gsub(/group-title="[^"]*"/, "group-title=\"RJM | News\"", line)
            }

            # ğŸŒ OTHER EXISTING GROUPS â†’ RJM | <Original>
            else if (line ~ /group-title="/) {
              match(line, /group-title="([^"]*)"/, arr)
              gsub(/group-title="[^"]*"/, "group-title=\"RJM | " arr[1] "\"", line)
            }

            # ğŸ†• NO GROUP-TITLE
            else {
              line = line " group-title=\"RJM | Others\""
            }

            print line
            next
          }

          { print }
          ' "$tmpdir/raw.m3u" | grep -v '^#EXTM3U' >> "$OUTPUT"

          rm -rf "$tmpdir"

          echo "âœ… P1js.m3u created successfully"
          echo "ğŸ“Š Total: $TOTAL | Updated: $UPDATED"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Bishop/P1js.m3u
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Auto update P1js.m3u (RJM grouping)"
          git push
